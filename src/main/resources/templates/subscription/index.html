<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <div th:replace="~{fragment :: meta}"></div>
    <div th:replace="~{fragment :: styles}"></div>
    <title>有料会員登録</title>
</head>
<body>
    <div class="nagoyameshi-wrapper">
        <div th:replace="~{fragment :: header}"></div>
        <main>
            <div class="container pt-4 pb-5 nagoyameshi-container">
                <div class="row justify-content-center">
                    <div class="col-xl-4 col-lg-5">
                        <nav class="mb-4" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a th:href="@{/}">ホーム</a></li>
                                <li class="breadcrumb-item active" aria-current="page">サブスクリプション有料会員登録</li>
                            </ol>
                        </nav>
                        <h1 class="text-center mb4">サブスクリプション有料会員登録</h1>
                        <div th:if="${successMessage}" class="alert alert-info" role="alert">
                            <span th:text="${successMessage}"></span>
                        </div>
                        <div>
                            <div id="cardHolderNameError"></div>
                            <input class="form-control mb-3 card-element" id="card-holder-name" type="text" required>
                            <div id="cardElementError"></div>
                            <div class="card-element mb-4" id="card-element"></div>
                            <input type="hidden" name="priceId">
                            <div class="d-flex justify-content-center">
                                <button id="paymentButton" class="btn text-white shadow-sm w-100 nagoyameshi-btn">決済する</button>
                            </div>
                        </div> 
                    </div>
                </div>
            </div>
        </main>
        <div th:replace="~{fragment :: footer}"></div>
    </div>
    
    <script src="https://js.stripe.com/v3/"></script>
    <script th:inline="javascript">
        const stripe = Stripe('pk_test_51PiVQRGc1SCcyjfLyeRzX3XxMVUdHfAyoVUF1ldt1u9fMb4YE6xoDE4TVtbd6dZcxyzWbxf2NJ0I7v1nMjSQFQJa00SP9RVTUw');
        
        // JSONデコードし、sessionIdを読み込む
        const sessionId = /*[[${sessionId}]]*/ "sessionId";
        
        const paymentButton = document.querySelector('#paymentButton');

        paymentButton.addEventListener('click', () => {
          stripe.redirectToCheckout({ sessionId: sessionId })
            .then(function (result) {
              if (result.error) {
                alert(result.error.message);
              }
            });
        });
    </script>
</body>
</html>
